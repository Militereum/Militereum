unit exploit;

interface

uses
  // Delphi
  System.Classes, System.SysUtils,
  // FireMonkey
  FMX.Controls, FMX.Controls.Presentation, FMX.Objects, FMX.StdCtrls, FMX.Types,
  // web3
  web3,
  // project
  base, revoke.cash, transaction;

type
  TFrmExploit = class(TFrmBase)
    lblTitle: TLabel;
    lblAddress: TLabel;
    lblDescription: TLabel;
    procedure lblAddressClick(Sender: TObject);
  strict private
    FExploit: IExploit;
    procedure SetAction(const value: TTokenAction);
    procedure SetContract(const value: TAddress);
    procedure SetExploit(const value: IExploit);
  public
    property Action: TTokenAction write SetAction;
    property Contract: TAddress write SetContract;
    property Exploit: IExploit write SetExploit;
  end;

procedure show(
  const action  : TTokenAction;
  const chain   : TChain;
  const tx      : transaction.ITransaction;
  const contract: TAddress;
  const exploit : IExploit;
  const callback: TProc<Boolean>; const log: TLog);

implementation

uses
  // project
  cache, common, thread;

{$R *.fmx}

procedure show(const action: TTokenAction; const chain: TChain; const tx: transaction.ITransaction; const contract: TAddress; const exploit: IExploit; const callback: TProc<Boolean>; const log: TLog);
begin
  const frmExploit = TFrmExploit.Create(chain, tx, callback, log);
  frmExploit.Action   := action;
  frmExploit.Contract := contract;
  frmExploit.Exploit  := exploit;
  frmExploit.Show;
end;

{ TFrmExploit }

procedure TFrmExploit.SetAction(const value: TTokenAction);
begin
  lblDescription.Text := System.SysUtils.Format(lblDescription.Text, [ActionText[value]]);
end;

procedure TFrmExploit.SetContract(const value: TAddress);
begin
  lblAddress.Text := string(value);
  cache.getFriendlyName(Self.Chain, value, procedure(friendly: string; err: IError)
  begin
    if Assigned(err) then Self.Log(err) else thread.synchronize(procedure
    begin
      lblAddress.Text := friendly;
    end);
  end);
end;

procedure TFrmExploit.SetExploit(const value: IExploit);
begin
  if value <> FExploit then
  begin
    FExploit := value;
    if Assigned(FExploit) then lblTitle.Text := FExploit.Name;
  end;
end;

procedure TFrmExploit.lblAddressClick(Sender: TObject);
begin
  if Assigned(FExploit) then common.Open(FExploit.URL(Self.Chain));
end;

end.
